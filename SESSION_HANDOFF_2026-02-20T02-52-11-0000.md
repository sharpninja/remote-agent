# Session Handoff — 2026-02-20T02:52 UTC

## Project Overview

**Remote Agent** — A system where a .NET MAUI Android app acts as a client to connect to an ASP.NET Core gRPC service running on a desktop/server. An Avalonia desktop management app lets the admin configure the service (set pairing users, API keys, manage sessions). The mobile app pairs with the service by logging in via a web browser flow that returns a `remoteagent://` deep link containing the API key + host + port.

---

## Repository Layout

```
src/
  RemoteAgent.App/            — .NET MAUI Android client (net10.0-android)
  RemoteAgent.App.Logic/      — Shared logic, CQRS interfaces, platform abstractions (net9.0 + net10.0)
  RemoteAgent.Desktop/        — Avalonia desktop management UI (net9.0)
  RemoteAgent.Proto/          — Protobuf contracts + generated gRPC C# (net9.0 + net10.0)
  RemoteAgent.Service/        — ASP.NET Core gRPC + web service (net10.0)
tests/
  RemoteAgent.App.Tests/      — Mobile app unit tests (net10.0)
  RemoteAgent.Service.Tests/  — Service unit tests (net10.0)
  RemoteAgent.Desktop.UiTests/— Avalonia desktop handler tests (net9.0)
  RemoteAgent.Service.IntegrationTests/ — Isolated integration tests (run manually)
scripts/
  build-dotnet10.sh           — Builds + tests MAUI app + service stack
  build-desktop-dotnet9.sh    — Builds + tests Avalonia desktop stack
  test-integration.sh         — Runs service integration tests (not part of CI)
  generate-proto.sh           — Regenerates gRPC C# from .proto (WSL/Linux only)
```

**Shared library multi-targeting:** `RemoteAgent.App.Logic` and `RemoteAgent.Proto` both target `net9.0;net10.0`. The desktop uses the net9.0 TFM, the service and mobile use net10.0.

---

## Build Commands

```bash
# MAUI + Service stack (.NET 10) — includes App.Tests + Service.Tests
bash ./scripts/build-dotnet10.sh Release

# Avalonia desktop stack (.NET 9) — includes Desktop.UiTests
bash ./scripts/build-desktop-dotnet9.sh Release

# Build Android APK manually (use Linux Android SDK):
dotnet build src/RemoteAgent.App/RemoteAgent.App.csproj \
  -c Release -f net10.0-android \
  -p:AndroidSdkDirectory=/home/sharpninja/Android/Sdk

# Install + launch on emulator (emulator-5556):
WIN_ADB="/mnt/c/Users/kingd/platform-tools-windows/platform-tools/adb.exe"
APK=$(find src/RemoteAgent.App/bin/Release/net10.0-android -name "*.apk" | grep -v Signed | head -1)
$WIN_ADB -s emulator-5556 install -r "$(wslpath -w "$APK")"
$WIN_ADB -s emulator-5556 shell am start -n com.companyname.remoteagent.app/crc6411305d2bb8acc544.MainActivity

# Always force-stop before relaunching to avoid Glide/activity destroyed crash:
$WIN_ADB -s emulator-5556 shell am force-stop com.companyname.remoteagent.app
```

**Important:** Always `force-stop` the app before `am start` — launching on top of a live instance causes a MAUI Shell + Glide race condition (destroyed activity exception).

---

## Architecture: Pairing Flow

### How pairing works end-to-end

1. Admin opens desktop app → enters username + password → clicks "Set Pairing User"
2. Desktop calls `SetPairingUsers` gRPC RPC → service saves hashed credentials + generates random 32-byte hex API key → writes both to `appsettings.json` → returns the new API key in the response
3. Service exposes two ports:
   - **gRPC port** (Windows: 5244, Linux: 5243) — HTTP/2 only
   - **Web port** (Windows: 15244, Linux: 15243) — HTTP/1+HTTP/2 for browser access; computed as `"1" + gRPCport`
4. Mobile user enters the server's host and gRPC port in the app → taps **Login**
5. App builds `http://{host}:1{port}/pair` and opens it in a `PairLoginPage` WebView modal
6. User logs in with the credentials set in step 1
7. Service redirects to `/pair/key` — renders HTML with the API key, a QR code (server-side PNG via QRCoder), and an `<a class="btn" href="remoteagent://pair?key=...&host=...&port=...">Open in App</a>`
8. `PairLoginPage.OnNavigated` fires when URL contains `/pair/key` → runs JS: `document.querySelector('a.btn')?.getAttribute('href')` → gets the `remoteagent://` deep link → closes modal, resolves TCS
9. `ScanQrCodeHandler.ParseAndApply()` parses the URI → populates `vm.Host`, `vm.Port`, `vm.ApiKey` → saves to preferences
10. Login button becomes disabled (HasApiKey is now true), Connect button becomes enabled
11. User taps **Connect** → `ConnectMobileSessionHandler` uses the stored API key

### Deep link format
```
remoteagent://pair?key={apiKey}&host={serverHost}&port={gRPCport}
```
Note: `port` in the deep link is the **gRPC port** (5244/5243), not the web port.

---

## Key Files — Mobile App (`src/RemoteAgent.App/`)

### `PairLoginPage.xaml` / `PairLoginPage.xaml.cs`
New modal page replacing the old camera QR scanner. Opens the server `/pair` URL in a WebView. On navigation to `/pair/key`, extracts the deep link from `<a class="btn">` via JavaScript and resolves the `TaskCompletionSource`. Handles JSON-quoted strings returned by Android's `EvaluateJavaScriptAsync`.

### `ViewModels/MainPageViewModel.cs`
- `ScanQrCodeCommand` CanExecute: `!HasApiKey && !string.IsNullOrWhiteSpace(_host)` — disabled until host is entered AND no key is stored
- `Host` setter calls `ChangeCanExecute` on `ScanQrCodeCommand`
- `ConnectCommand` CanExecute: `!_gateway.IsConnected && HasApiKey`
- `ApiKey` setter: persists to prefs, fires `HasApiKey`, calls ChangeCanExecute on both commands
- `HasApiKey`: `!string.IsNullOrWhiteSpace(_apiKey)`
- Prefs keys: `ServerHost`, `ServerPort`, `PerRequestContext`, `ApiKey`

### `Handlers/ScanQrCodeHandler.cs`
- Validates host is present before building login URL
- Builds `loginUrl = $"http://{host}:1{port}/pair"` (web port = `"1" + gRPCport`)
- Passes `loginUrl` to `IQrCodeScanner.ScanAsync(loginUrl)`
- Parses returned `remoteagent://` URI via `ParseAndApply()`
- Status messages: "Enter a host address before logging in.", "Login cancelled.", "Pairing details loaded. Tap Connect to continue."

### `Services/MauiPlatformServices.cs` — `MauiQrCodeScanner`
```csharp
public async Task<string?> ScanAsync(string loginUrl)
{
    var scanPage = new PairLoginPage(loginUrl);
    await MainThread.InvokeOnMainThreadAsync(
        () => Shell.Current.Navigation.PushModalAsync(scanPage, animated: true));
    return await scanPage.ResultTask;
}
```
Uses `Shell.Current.Navigation` (not `page.Navigation`) to avoid Android modal push no-op.

### `Handlers/ConnectMobileSessionHandler.cs`
- Forwards `workspace.ApiKey` to `GetServerInfoAsync` and `GetSessionCapacityAsync`
- On successful connect: persists `ApiKey` to preferences (`PrefApiKey = "ApiKey"`)

### `MauiProgram.cs`
- `IQrCodeScanner` registered as `AddSingleton<IQrCodeScanner, MauiQrCodeScanner>()`
- ZXing removed — no `UseBarcodeReader()`, no `ZXing.Net.Maui.Controls` package

---

## Key Files — Service (`src/RemoteAgent.Service/`)

### `Web/PairingHtml.cs`
- `LoginPage(bool error, bool noPairingUsers)` — renders login form HTML
- `KeyPage(string apiKey, string deepLink)` — renders API key display + QR code + deep link button
- QR code generated server-side via `QRCoder.PngByteQRCode` → embedded as `data:image/png;base64,...` in `<img>` tag (no CDN, air-gap safe)

### `Program.cs` — `/pair` routes
All three `/pair` lambdas use **`IOptionsMonitor<AgentOptions>.CurrentValue`** (not `IOptions<T>`) so they reload after `SetPairingUsers` writes `appsettings.json`. The deep link built at `/pair/key` uses `context.Request.Host` to get the server's actual IP/hostname.

### `Services/AgentGatewayService.cs` — `SetPairingUsers` RPC
- Hashes passwords with SHA-256
- Generates a 32-byte random hex API key via `RandomNumberGenerator.GetBytes(32)`
- Writes `Agent:ApiKey` and `Agent:PairingUsers` to `appsettings.json`
- Returns the new key in `SetPairingUsersResponse.GeneratedApiKey`

---

## Key Files — Desktop (`src/RemoteAgent.Desktop/`)

### `Handlers/SetPairingUserHandler.cs`
- Dispatches `SetPairingUsersAsync` to the service
- Applies returned API key to `Workspace.ApiKey`

### `Infrastructure/ServerCapacityClient.cs`
- `SetPairingUsersAsync` returns `Task<string>` (the generated API key), not `Task<bool>`
- Throws `InvalidOperationException` on failure

### `App.axaml`
- Global style: `Button, TextBox, ComboBox, CheckBox, ListBox, SelectableTextBlock, TabControl` all get 4px `Margin`
- All `TextBlock` replaced with `SelectableTextBlock` across all 16 `.axaml` view files

---

## Key Files — Shared (`src/RemoteAgent.App.Logic/`)

### `PlatformAbstractions.cs` — `IQrCodeScanner`
```csharp
public interface IQrCodeScanner
{
    Task<string?> ScanAsync(string loginUrl);
}
```

---

## Proto Contract

### `AgentGateway.proto` — `SetPairingUsersResponse`
```protobuf
message SetPairingUsersResponse {
  bool success = 1;
  string error_message = 2;
  string generated_api_key = 3;
}
```
Generated files are checked in at `src/RemoteAgent.Proto/Generated/` — do not use Grpc.Tools MSBuild codegen.

---

## Current Test Counts (all passing)
- `RemoteAgent.App.Tests` — **111 tests**
- `RemoteAgent.Service.Tests` — **27 tests**
- `RemoteAgent.Desktop.UiTests` — **173 tests** (last known passing, .NET 9)

---

## Pending Work (from SQL todos)

These todos were planned for the original `SetPairingUsers` feature but are **already fully implemented** in `commit f37e28e` and subsequent commits. The SQL table is stale — all the work listed below is **DONE** in the codebase:

| SQL ID | Title | Reality |
|--------|-------|---------|
| `proto-update` | Update proto file | ✅ Done in f37e28e |
| `proto-gen` | Regenerate proto | ✅ Done in f37e28e |
| `service-impl` | Service implementation | ✅ Done in f37e28e |
| `client-impl` | Desktop client | ✅ Done in 2c30fd5 |
| `request-handler` | Request/Handler | ✅ Done in f37e28e |
| `app-registration` | App.axaml.cs registration | ✅ Done in f37e28e |
| `dialog-infra` | Dialog infrastructure | ✅ Done in f37e28e |
| `mainwindow-xaml` | MainWindow toolbar button | ✅ Done in f37e28e |
| `viewmodel-updates` | ViewModel updates | ✅ Done in f37e28e |
| `test-file` | Test file | ✅ Done in 2c30fd5 |
| `test-stubs` | Test stubs | ✅ Done in 2c30fd5 |
| `build-verify` | Build and verify | ✅ 138 tests pass |

**There are no known outstanding tasks.**

---

## Known Issues / Gotchas

### Android build on Linux
Building the APK requires the Linux Android SDK. Use:
```
-p:AndroidSdkDirectory=/home/sharpninja/Android/Sdk
```
The Windows SDK path (`/mnt/c/Users/kingd/AppData/Local/Android/Sdk`) does not have Linux `zipalign` and will fail with `XA5205`.

### Desktop build on Linux (NETSDK1045)
`build-desktop-dotnet9.sh` shows `NETSDK1045` for `RemoteAgent.App.Logic` and `RemoteAgent.Proto` when run on this machine because the .NET 9 SDK (9.0.311) sees the `net10.0` TFM in those multi-target projects. **This is a Linux environment-only issue** — CI uses .NET 10 SDK which handles it fine. The desktop itself only uses the `net9.0` TFM from those libraries.

### `PairLoginPage` JS deep link extraction
`EvaluateJavaScriptAsync` on Android WebView returns JSON-quoted strings (e.g., `"\"remoteagent://...\""`) — the code strips surrounding quotes if present. If the `<a class="btn">` anchor is not present on the page (e.g., no API key configured), the JS returns `null` and the page stays open.

### `IOptions` vs `IOptionsMonitor`
All `/pair` routes use `IOptionsMonitor<AgentOptions>.CurrentValue` so settings reload after `SetPairingUsers` writes `appsettings.json`. Using `IOptions<T>` would snapshot at startup and never see the new credentials/key.

### Port convention
- gRPC port: 5244 (Windows), 5243 (Linux/Docker)
- Web (browser) port: 15244 (Windows), 15243 (Linux/Docker)
- Formula: `webPort = "1" + gRPCport`
- Deep link contains the **gRPC port**, not the web port
- The web port is only used to navigate the login WebView

### ADB on WSL2
Windows ADB binary: `/mnt/c/Users/kingd/platform-tools-windows/platform-tools/adb.exe`
Pass APK path via `wslpath -w "$APK"` for Windows-compatible path.
Emulator: `emulator-5556`
Activity class: `crc6411305d2bb8acc544.MainActivity`
Package: `com.companyname.remoteagent.app`

---

## Recent Commit History

```
1dfe673  Replace QR camera scanner with server login webview for pairing
0a3e7e7  Fix: generate QR code server-side (embedded PNG) instead of CDN JS
324f229  Style: global 4px margin on all interactive/display controls in Avalonia app
0b491de  UX: SelectableTextBlock everywhere in Avalonia; simplify mobile login UI; persist ApiKey on connect
25a470e  Fix: use Shell.Current.Navigation + MainThread for QR scanner modal push
ddaa2f1  Fix: forward ApiKey to server info and capacity checks in ConnectMobileSessionHandler
2c30fd5  Feat: generate and return API key when saving pairing user
db645e3  Fix: use IOptionsMonitor so /pair reloads after SetPairingUsers writes appsettings.json
f37e28e  feat: SetPairingUsers — PS script + Desktop toolbar + gRPC RPC
b0d82d5  feat: serve /pair web UI on dedicated HTTP/1+2 port (1+gRPC port)
```
