# Session Handoff — 2026-02-20T05:22 UTC

## Project Overview

**Remote Agent** — A system consisting of:
- **.NET MAUI Android app** (`net10.0-android`) — client that connects to a gRPC service, manages chat sessions with AI agents
- **ASP.NET Core gRPC service** (`net10.0`) — runs agent sessions, handles pairing/auth
- **Avalonia desktop management app** (`net9.0`) — admin tool for configuring the service (pairing users, API keys, server profiles, session management)

---

## Repository Layout

```
src/
  RemoteAgent.App/            — .NET MAUI Android client
  RemoteAgent.App.Logic/      — Shared logic, CQRS interfaces, platform abstractions (net9.0 + net10.0)
  RemoteAgent.Desktop/        — Avalonia desktop management UI (net9.0)
  RemoteAgent.Proto/          — Protobuf contracts + generated gRPC C# (net9.0 + net10.0)
  RemoteAgent.Service/        — ASP.NET Core gRPC + web service (net10.0)
tests/
  RemoteAgent.App.Tests/      — Mobile app unit tests (net10.0, 117 tests)
  RemoteAgent.Service.Tests/  — Service unit tests (net10.0, 27 tests)
  RemoteAgent.Desktop.UiTests/— Avalonia desktop handler tests (net9.0, 173 tests)
  RemoteAgent.Service.IntegrationTests/ — Isolated integration tests (run manually)
scripts/
  build-dotnet10.sh           — Builds + tests MAUI app + service stack
  build-desktop-dotnet9.sh    — Builds + tests Avalonia desktop stack
  test-integration.sh         — Runs service integration tests (not part of CI)
  generate-proto.sh           — Regenerates gRPC C# from .proto (WSL/Linux only)
```

**Multi-targeting:** `RemoteAgent.App.Logic` and `RemoteAgent.Proto` target `net9.0;net10.0`. Desktop uses net9.0 TFM, service/mobile use net10.0.

---

## Build Commands

```bash
# MAUI + Service stack (.NET 10) — includes App.Tests + Service.Tests
bash ./scripts/build-dotnet10.sh Release

# Avalonia desktop stack (.NET 9) — includes Desktop.UiTests
bash ./scripts/build-desktop-dotnet9.sh Release

# Build Android APK (Debug only — Release hits XAGNM7009 ARM64 issue):
dotnet publish src/RemoteAgent.App/RemoteAgent.App.csproj \
  -c Debug -f net10.0-android \
  -p:AndroidSdkDirectory=/home/sharpninja/Android/Sdk \
  -p:EmbedAssembliesIntoApk=true

# Install + launch on emulator:
WIN_ADB="/mnt/c/Users/kingd/platform-tools-windows/platform-tools/adb.exe"
APK=$(find src/RemoteAgent.App/bin/Debug/net10.0-android -name '*-Signed.apk' | head -1)
$WIN_ADB -s emulator-5556 shell am force-stop com.companyname.remoteagent.app
$WIN_ADB -s emulator-5556 install -r "$(wslpath -w "$APK")"
$WIN_ADB -s emulator-5556 shell am start -n com.companyname.remoteagent.app/crc6411305d2bb8acc544.MainActivity

# Screenshot:
$WIN_ADB -s emulator-5556 exec-out screencap -p > /tmp/screenshot.png

# Desktop build (use dotnet build directly — build script hits NETSDK1045):
dotnet build src/RemoteAgent.Desktop/RemoteAgent.Desktop.csproj -c Release
dotnet test tests/RemoteAgent.Desktop.UiTests/RemoteAgent.Desktop.UiTests.csproj -c Release
```

---

## Current Test Counts (all passing as of this handoff)

- `RemoteAgent.App.Tests` — **117 tests** (includes 7 new server-profile handler tests)
- `RemoteAgent.Service.Tests` — **27 tests**
- `RemoteAgent.Desktop.UiTests` — **173 tests**
- **Total: 317 tests, all green**

---

## Architecture: CQRS Pattern (Mobile)

All mobile UI actions dispatch through `IRequestDispatcher`:

```
ViewModel command → new XxxRequest(Guid, workspace) → IRequestDispatcher.SendAsync()
  → DI resolves IRequestHandler<XxxRequest, CommandResult> → handler.HandleAsync()
```

**Request files:** `src/RemoteAgent.App/Requests/`
**Handler files:** `src/RemoteAgent.App/Handlers/`
**Registration:** `src/RemoteAgent.App/MauiProgram.cs` (transient handlers)
**Tests:** `tests/RemoteAgent.App.Tests/` (linked source files from App project via csproj `<Compile Include>`)

The test project can't reference `RemoteAgent.App` directly (MAUI workload). Instead, it links individual `.cs` files and uses `MauiStubs.cs` for minimal `Microsoft.Maui.Controls.Command` stub.

### Adding a new CQRS command:
1. Create `XxxRequest.cs` in `Requests/` (implements `IRequest<CommandResult>`)
2. Create `XxxHandler.cs` in `Handlers/` (implements `IRequestHandler<XxxRequest, CommandResult>`)
3. Register in `MauiProgram.cs`: `builder.Services.AddTransient<IRequestHandler<XxxRequest, CommandResult>, XxxHandler>()`
4. Add `<Compile Include>` links in `RemoteAgent.App.Tests.csproj` for both files
5. Create `XxxHandlerTests.cs` in tests
6. Wire ViewModel: `new Command(async () => await RunAsync(new XxxRequest(Guid.NewGuid(), this)))`

---

## Architecture: Pairing Flow

1. Admin sets pairing credentials via Desktop → `SetPairingUsers` gRPC RPC → service saves hashed creds + generates API key → writes to `appsettings.json`
2. Mobile user enters host + port → taps **Login** → WebView opens `http://{host}:1{port}/pair`
3. User logs in → service redirects to `/pair/key` → shows API key + QR + deep link button
4. `PairLoginPage` extracts deep link via JS → parses `remoteagent://pair?key=...&host=...&port=...`
5. API key stored → **Connect** button enabled → gRPC connection established

**Port convention:**
- gRPC: 5243 (Linux/Docker, default), 5244 (Windows)
- Web/browser: 15243 / 15244 (formula: `"1" + gRPCport`)
- Deep link contains gRPC port, not web port

---

## Feature: Server Profiles

**Fully implemented** on both mobile and desktop.

### Mobile (`src/RemoteAgent.App/`)
- `ServerProfile` model + `IServerProfileStore` interface in `App.Logic/ServerProfile.cs`
- `LocalServerProfileStore` (LiteDB) in `Services/LocalServerProfileStore.cs`
- `SettingsPage.xaml` — lists saved servers, edit display name / per-request context / default session context
- **CQRS handlers:** `SaveServerProfileHandler`, `DeleteServerProfileHandler`, `ClearServerApiKeyHandler`
- `SettingsPageViewModel` dispatches all commands via `IRequestDispatcher`
- `ConnectMobileSessionHandler` auto-saves profile on successful connect
- API key status shown with "Clear API Key" button

### Desktop (`src/RemoteAgent.Desktop/`)
- `ServerRegistration` model extended with `PerRequestContext` + `DefaultSessionContext`
- `ServerRegistrationStore.Upsert` persists new fields
- `ServerSetupPanel.axaml` has text areas for per-request and default session context
- `SaveServerRegistrationRequest/Handler` passes new fields through

---

## Recent Changes (this session)

### Commits (oldest → newest):
```
2d2b678  Add server profiles: save connection details per host:port
41796c9  Make Enter key send message on Android
6384ba0  Add FR-19/20, TR-21/22: server profiles and mobile chat UX requirements
5ceb870  Fix Android Enter-to-send, icon-only Send button, compact button padding
bfdc4da  CQRS server profile handlers + clear API key feature
032e786  Replace .NET splash screen logo with app icon
588fcd7  Fix Android soft keyboard Enter: show Send action instead of newline
```

### Key changes:
1. **Server profiles** — Full CQRS implementation with 3 request/handler pairs, tests, settings UI
2. **Android Enter-to-send** — `SetRawInputType(InputTypes.ClassText)` on native `AppCompatEditText` forces IME to show Send button instead of newline for multi-line Editor
3. **Compact mobile chat UI** — Removed icon label from input area, shrunk session tab close buttons (24×24), compact session card buttons, toolbar reduced to Connect/Disconnect only
4. **Splash screen** — Replaced .NET logo with app's own icon (`appiconfg.svg`)
5. **Default port** — Changed from 5244 to 5243 (Linux/Docker is more common deployment)

---

## Key Files Reference

### Mobile App
| File | Purpose |
|------|---------|
| `MainPage.xaml` | Chat screen — connection view, session tabs, message list, input area |
| `MainPage.xaml.cs` | Platform-specific keyboard: Android `EditorAction`+`SetRawInputType`, Windows Ctrl+Enter |
| `SettingsPage.xaml` | Server profiles list + edit form + Clear API Key |
| `ViewModels/MainPageViewModel.cs` | Main VM, default port 5243, CQRS dispatch via `RunAsync()` |
| `ViewModels/SettingsPageViewModel.cs` | Settings VM, CQRS dispatch for Save/Delete/ClearApiKey |
| `MauiProgram.cs` | DI registration hub — all handlers, services, ViewModels |
| `Handlers/ClearServerApiKeyHandler.cs` | Clears API key from stored profile |
| `Resources/Splash/splash.svg` | Splash screen (now app icon, not .NET logo) |
| `Resources/Styles/Styles.xaml` | Global Button style: padding `12,6`, min height `36` |

### Service
| File | Purpose |
|------|---------|
| `Program.cs` | Kestrel setup, dual-port (gRPC + web), `/pair` routes |
| `Services/AgentGatewayService.cs` | gRPC service: Connect, SendMessage, SetPairingUsers |
| `Web/PairingHtml.cs` | Login form + key page HTML generation |

### Desktop
| File | Purpose |
|------|---------|
| `Infrastructure/ServerRegistration.cs` | Server model with PerRequestContext + DefaultSessionContext |
| `Views/Panels/ServerSetupPanel.axaml` | Per-request context + default session context text fields |

### Shared
| File | Purpose |
|------|---------|
| `App.Logic/ServerProfile.cs` | ServerProfile model + IServerProfileStore interface |
| `App.Logic/Cqrs/` | IRequest, IRequestHandler, IRequestDispatcher, CommandResult |

---

## Outstanding Work

### Active bug:
- **`debug-server-agents`** — Agents aren't running on the server. Need to investigate service logs, gRPC session lifecycle, agent spawning logic. This is the highest priority item.

### Stale SQL todos (already implemented, can be marked done):
The following SQL todo items are from the `SetPairingUsers` feature that was completed in prior sessions. They can be cleaned up:
- `proto-update`, `proto-gen`, `service-impl`, `client-impl`, `request-handler`
- `app-registration`, `dialog-infra`, `mainwindow-xaml`, `viewmodel-updates`
- `test-file`, `test-stubs`, `build-verify`

### Remaining from server profiles plan:
- `desktop-profile-align` (in_progress) — Desktop PerRequestContext/DefaultSessionContext fields were added. May need further testing.
- `profile-tests` (pending) — Additional unit tests for profile store CRUD and auto-save. Basic handler tests exist (7 in `ServerProfileHandlerTests.cs`), but more coverage could be added.

---

## Known Issues / Gotchas

### Android APK build
- **Release config fails** with `XAGNM7009` (native code gen ARM64 issue in .NET 10 Android SDK 36.1.30). Use **Debug** config with `-p:EmbedAssembliesIntoApk=true`.
- Requires Linux Android SDK: `-p:AndroidSdkDirectory=/home/sharpninja/Android/Sdk`

### Android soft keyboard Enter key
- MAUI `Editor` = multi-line `AppCompatEditText`. Android ignores `ImeOptions` for multi-line inputs.
- Fix: `SetRawInputType(InputTypes.ClassText)` tells IME to show Send button while view still wraps text.
- `EditorAction` event handles `ImeAction.Send`, `Done`, and `Unspecified` (hardware Enter).

### Desktop build on Linux (NETSDK1045)
- `build-desktop-dotnet9.sh` shows NETSDK1045 because .NET 9 SDK doesn't know `net10.0`.
- Workaround: Build desktop directly with `dotnet build src/RemoteAgent.Desktop/RemoteAgent.Desktop.csproj -c Release` (the .NET 10 SDK can build net9.0 targets).

### Test project linking
- `RemoteAgent.App.Tests` can't reference the MAUI app project. Source files are linked via `<Compile Include="..\..\src\RemoteAgent.App\...\File.cs" Link="App\...\File.cs" />` in the `.csproj`.
- `MauiStubs.cs` provides minimal `Microsoft.Maui.Controls.Command` stub.
- **When adding new request/handler files, you must add corresponding `<Compile Include>` links.**

### `IOptions` vs `IOptionsMonitor`
- All `/pair` routes use `IOptionsMonitor<AgentOptions>.CurrentValue` so settings reload after `SetPairingUsers` writes `appsettings.json`.

### ADB on WSL2
- Windows ADB: `/mnt/c/Users/kingd/platform-tools-windows/platform-tools/adb.exe`
- APK paths via `wslpath -w "$APK"` for Windows-compatible paths
- Emulator: `emulator-5556`
- Activity: `crc6411305d2bb8acc544.MainActivity`
- Package: `com.companyname.remoteagent.app`
- Always `force-stop` before relaunching to avoid destroyed-activity crashes

### Warnings as errors
- `TreatWarningsAsErrors=true` in `Directory.Build.props`
- Fix nullability issues, don't suppress warnings without approval

### Requirements matrix script
- `scripts/generate-requirements-matrix.sh` has pre-existing awk syntax errors
- Matrix entries in `docs/requirements-test-coverage.md` must be added manually

---

## Recent Commit History

```
588fcd7  Fix Android soft keyboard Enter: show Send action instead of newline
032e786  Replace .NET splash screen logo with app icon
bfdc4da  CQRS server profile handlers + clear API key feature
5ceb870  Fix Android Enter-to-send, icon-only Send button, compact button padding
6384ba0  Add FR-19/20, TR-21/22: server profiles and mobile chat UX requirements
41796c9  Make Enter key send message on Android
2d2b678  Add server profiles: save connection details per host:port
22da942  Hide connection card in chat view when already connected
b3d01ac  Hide navigation until connection and session are established
a6e698c  Migrate GetSessionCapacityAsync to gRPC, remove dead HTTP helpers
9ef7799  Hardcode server connection mode on Android, remove mode selector dialog
5b4f109  docs: add FR-17/18 and TR-19/20 for device pairing, API key management, and desktop UX
a7add4c  docs: update session handoff 2026-02-20
1dfe673  Replace QR camera scanner with server login webview for pairing
0a3e7e7  Fix: generate QR code server-side (embedded PNG) instead of CDN JS
324f229  Style: global 4px margin on all interactive/display controls in Avalonia app
0b491de  UX: SelectableTextBlock everywhere in Avalonia; simplify mobile login UI; persist ApiKey on connect
25a470e  Fix: use Shell.Current.Navigation + MainThread for QR scanner modal push
ddaa2f1  Fix: forward ApiKey to server info and capacity checks in ConnectMobileSessionHandler
2c30fd5  Feat: generate and return API key when saving pairing user
```
