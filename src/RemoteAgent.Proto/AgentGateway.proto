syntax = "proto3";

option csharp_namespace = "RemoteAgent.Proto";

package remoteagent;

// AgentGateway: bidirectional streaming between app and Cursor agent.
service AgentGateway {
  // GetServerInfo returns server version and capabilities. Call when starting a connection.
  rpc GetServerInfo (ServerInfoRequest) returns (ServerInfoResponse);
  // Connect opens a persistent duplex stream. Client sends messages;
  // server streams agent output and session events.
  rpc Connect (stream ClientMessage) returns (stream ServerMessage);
}

// ServerInfoRequest: optional client info for handshake (e.g. future compatibility).
message ServerInfoRequest {
  string client_version = 1;  // optional app version
}

// ServerInfoResponse: server version, capabilities, available agents and models.
message ServerInfoResponse {
  string server_version = 1;       // e.g. 1.0.0
  repeated string capabilities = 2; // e.g. "scripts", "media_upload", "agents"
  repeated string available_agents = 3;  // runner ids (e.g. "process", plugin names)
  repeated string available_models = 4;  // optional model ids the server can use (future)
}

// ClientMessage: payload sent from the app to the service.
message ClientMessage {
  oneof payload {
    string text = 1;           // user message to forward to the agent
    SessionControl control = 2; // start/stop session
    ScriptRequest script_request = 3;  // run a script (bash/pwsh), get stdout/stderr on completion (FR-9.1)
    MediaUpload media_upload = 4;  // image or video as context for the agent (FR-10.1)
  }
}

// MediaUpload: image or video sent from app to server as agent context (FR-10.1). Stored alongside LiteDB (TR-11.2).
message MediaUpload {
  bytes content = 1;
  string content_type = 2;   // e.g. image/jpeg, video/mp4
  string file_name = 3;      // original filename for storage
}

// ScriptRequest: run a script and return stdout/stderr when done (FR-9.1, FR-9.2).
message ScriptRequest {
  string path_or_command = 1;   // path to script file or command string
  ScriptType script_type = 2;  // bash or pwsh
}

enum ScriptType {
  SCRIPT_TYPE_UNSPECIFIED = 0;
  BASH = 1;
  PWSH = 2;
}

// SessionControl: start or end the agent session.
message SessionControl {
  enum Action {
    ACTION_UNSPECIFIED = 0;
    START = 1;  // spawn agent and start session
    STOP = 2;   // end session and stop agent
  }
  Action action = 1;
}

// ServerMessage: payload streamed from the service to the app.
message ServerMessage {
  oneof payload {
    string output = 1;       // agent stdout / response chunk (real-time)
    string error = 2;         // agent stderr
    SessionEvent event = 3;  // session started / stopped / error
    MediaChunk media = 5;     // image (or other media) sent to app; store in DCIM/Remote Agent (TR-11.3)
  }
  // Priority for this message. NOTIFY triggers a system notification; tap opens chat and shows message.
  MessagePriority priority = 4;
}

// MediaChunk: image/media sent from server to app. App stores in DCIM/Remote Agent (TR-11.3).
message MediaChunk {
  bytes content = 1;
  string content_type = 2;   // e.g. image/png
  string file_name = 3;      // suggested filename
}

// MessagePriority: normal, high, or notify (system notification + tap to show).
enum MessagePriority {
  MESSAGE_PRIORITY_UNSPECIFIED = 0;
  NORMAL = 1;
  HIGH = 2;
  NOTIFY = 3;
}

// SessionEvent: session lifecycle for the UI.
message SessionEvent {
  enum Kind {
    KIND_UNSPECIFIED = 0;
    SESSION_STARTED = 1;
    SESSION_STOPPED = 2;
    SESSION_ERROR = 3;
  }
  Kind kind = 1;
  string message = 2;  // optional detail (e.g. error message)
}
