<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:fa="using:FluentAvalonia.UI.Controls"
        xmlns:tb="using:ToolBarControls.Avalonia"
        xmlns:behaviors="using:RemoteAgent.Desktop.Behaviors"
        xmlns:panels="using:RemoteAgent.Desktop.Views.Panels"
        x:Class="RemoteAgent.Desktop.Views.MainWindow"
        Width="800"
        Height="720"
        MinWidth="760"
        MinHeight="600"
        Background="{DynamicResource WindowBackgroundBrush}"
        FontFamily="{DynamicResource AppFontFamily}"
        Title="Remote Agent Management"
        mc:Ignorable="d">
  <Window.Resources>
    <x:Double x:Key="UnifiedUiFontSize">13</x:Double>
  </Window.Resources>
  <Window.Styles>
    <Style Selector="Control">
      <Setter Property="Margin" Value="4" />
    </Style>
    <Style Selector="TextBlock">
      <Setter Property="FontSize" Value="{DynamicResource UnifiedUiFontSize}" />
    </Style>
    <Style Selector="Button">
      <Setter Property="Padding" Value="4" />
      <Setter Property="FontSize" Value="{DynamicResource UnifiedUiFontSize}" />
    </Style>
    <Style Selector="TextBox">
      <Setter Property="Padding" Value="4" />
      <Setter Property="FontSize" Value="{DynamicResource UnifiedUiFontSize}" />
    </Style>
    <Style Selector="ComboBox">
      <Setter Property="Padding" Value="4" />
      <Setter Property="FontSize" Value="{DynamicResource UnifiedUiFontSize}" />
    </Style>
    <Style Selector="CheckBox">
      <Setter Property="Padding" Value="4" />
      <Setter Property="FontSize" Value="{DynamicResource UnifiedUiFontSize}" />
    </Style>
    <Style Selector="TabItem">
      <Setter Property="Padding" Value="4" />
      <Setter Property="FontSize" Value="{DynamicResource UnifiedUiFontSize}" />
    </Style>
    <Style Selector="ListBoxItem">
      <Setter Property="Padding" Value="4" />
      <Setter Property="FontSize" Value="{DynamicResource UnifiedUiFontSize}" />
    </Style>
    <Style Selector="MenuItem">
      <Setter Property="Padding" Value="4" />
      <Setter Property="FontSize" Value="{DynamicResource UnifiedUiFontSize}" />
    </Style>
    <Style Selector="fa|NavigationViewItem">
      <Setter Property="Padding" Value="2,6,8,6" />
      <Setter Property="Margin" Value="0" />
    </Style>
    <Style Selector="fa|NavigationViewItem StackPanel">
      <Setter Property="Margin" Value="-14,0,0,0" />
    </Style>
    <Style Selector="fa|FontIcon">
      <Setter Property="FontFamily" Value="{DynamicResource IconFontFamily}" />
    </Style>
    <Style Selector="fa|NavigationViewItem fa|FontIcon">
      <Setter Property="Margin" Value="2,0,0,0" />
      <Setter Property="Width" Value="16" />
      <Setter Property="FontSize" Value="16" />
    </Style>
    <Style Selector="fa|NavigationViewItem TextBlock">
      <Setter Property="Margin" Value="0" />
    </Style>
  </Window.Styles>
  <DockPanel LastChildFill="True">
    <Menu DockPanel.Dock="Top" FontSize="{DynamicResource UnifiedUiFontSize}">
      <MenuItem Header="_File">
        <MenuItem.Icon>
          <fa:FontIcon Glyph="&#xE8A5;" />
        </MenuItem.Icon>
        <MenuItem Header="New Session" Command="{Binding StartSessionCommand}">
          <MenuItem.Icon>
            <fa:FontIcon Glyph="&#xE710;" />
          </MenuItem.Icon>
        </MenuItem>
        <MenuItem Header="Terminate Session" Command="{Binding CurrentServerViewModel.TerminateCurrentSessionCommand}">
          <MenuItem.Icon>
            <fa:FontIcon Glyph="&#xE711;" />
          </MenuItem.Icon>
        </MenuItem>
      </MenuItem>
      <MenuItem Header="_Local Server">
        <MenuItem.Icon>
          <fa:FontIcon Glyph="&#xEC4F;" />
        </MenuItem.Icon>
        <MenuItem x:Name="CheckLocalServerMenuItem" Header="Check Local Server" Command="{Binding CheckLocalServerCommand}">
          <MenuItem.Icon>
            <fa:FontIcon Glyph="&#xE72C;" />
          </MenuItem.Icon>
        </MenuItem>
        <MenuItem x:Name="ApplyLocalServerActionMenuItem" Header="{Binding LocalServerActionLabel}" Command="{Binding ApplyLocalServerActionCommand}">
          <MenuItem.Icon>
            <fa:FontIcon Glyph="&#xE768;" />
          </MenuItem.Icon>
        </MenuItem>
      </MenuItem>
      <MenuItem Header="_View">
        <MenuItem.Icon>
          <fa:FontIcon Glyph="&#xE7F4;" />
        </MenuItem.Icon>
        <MenuItem Header="Toggle Theme" Command="{Binding CurrentServerViewModel.ToggleThemeCommand}">
          <MenuItem.Icon>
            <fa:FontIcon Glyph="&#xE793;" />
          </MenuItem.Icon>
        </MenuItem>
      </MenuItem>
    </Menu>

    <tb:ToolBarTray DockPanel.Dock="Top" Margin="0" IsLocked="True" Orientation="Horizontal" HorizontalAlignment="Stretch">
      <tb:ToolBar Band="0" BandIndex="0">
        <Button x:Name="NewSessionButton" Command="{Binding StartSessionCommand}">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <fa:FontIcon Glyph="&#xE710;" />
            <TextBlock VerticalAlignment="Center" Text="New Session" />
          </StackPanel>
        </Button>
        <Button x:Name="RefreshOpenSessionsButton" Command="{Binding CurrentServerViewModel.Security.RefreshOpenSessionsCommand}">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <fa:FontIcon Glyph="&#xE72C;" />
            <TextBlock VerticalAlignment="Center" Text="Refresh Open Sessions" />
          </StackPanel>
        </Button>
        <Button x:Name="TerminateOpenServerSessionButton" Command="{Binding CurrentServerViewModel.Security.TerminateOpenServerSessionCommand}">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <fa:FontIcon Glyph="&#xE711;" />
            <TextBlock VerticalAlignment="Center" Text="Terminate Open Session" />
          </StackPanel>
        </Button>
        <Button x:Name="TerminateSessionButton" Command="{Binding CurrentServerViewModel.TerminateCurrentSessionCommand}">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <fa:FontIcon Glyph="&#xE711;" />
            <TextBlock VerticalAlignment="Center" Text="Terminate Session" />
          </StackPanel>
        </Button>
        <Button x:Name="CheckLocalServerButton" Command="{Binding CheckLocalServerCommand}">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <fa:FontIcon Glyph="&#xE72C;" />
            <TextBlock VerticalAlignment="Center" Text="Check Server Status" />
          </StackPanel>
        </Button>
        <Button x:Name="ApplyLocalServerActionButton" Command="{Binding ApplyLocalServerActionCommand}">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <fa:FontIcon Glyph="&#xE768;" />
            <TextBlock VerticalAlignment="Center" Text="{Binding LocalServerActionLabel}" />
          </StackPanel>
        </Button>
        <Button x:Name="ToggleThemeButton" Command="{Binding CurrentServerViewModel.ToggleThemeCommand}">
          <StackPanel Orientation="Horizontal" Spacing="6">
            <fa:FontIcon Glyph="&#xE793;" />
            <TextBlock VerticalAlignment="Center" Text="Light/Dark" />
          </StackPanel>
        </Button>
      </tb:ToolBar>
    </tb:ToolBarTray>

    <Border DockPanel.Dock="Bottom"
            IsVisible="{Binding IsStatusLogExpanded}"
            Background="{DynamicResource WindowCardBackgroundBrush}"
            BorderBrush="{DynamicResource WindowDividerBrush}"
            BorderThickness="0,1,0,0"
            MaxHeight="240">
      <Grid RowDefinitions="Auto,*" Margin="6,4">
        <DockPanel Grid.Row="0" LastChildFill="False">
          <TextBlock DockPanel.Dock="Left" FontWeight="SemiBold" Text="Status Log" />
          <Button DockPanel.Dock="Right"
                  Padding="6,2"
                  Command="{Binding CollapseStatusLogCommand}">
            <StackPanel Orientation="Horizontal" Spacing="4">
              <fa:FontIcon Glyph="&#xE711;" />
              <TextBlock Text="Close" />
            </StackPanel>
          </Button>
          <Button DockPanel.Dock="Right"
                  Padding="6,2"
                  Command="{Binding CopyStatusLogCommand}">
            <StackPanel Orientation="Horizontal" Spacing="4">
              <fa:FontIcon Glyph="&#xE8C8;" />
              <TextBlock Text="Copy as Markdown" />
            </StackPanel>
          </Button>
        </DockPanel>
        <Border Grid.Row="1"
                Background="{DynamicResource WindowBackgroundBrush}"
                BorderBrush="{DynamicResource WindowBorderBrush}"
                BorderThickness="1"
                CornerRadius="4"
                Margin="0,4,0,0">
          <ScrollViewer VerticalScrollBarVisibility="Auto">
            <ItemsControl ItemsSource="{Binding StatusLogEntries}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Grid ColumnDefinitions="Auto,*" Margin="6,2">
                    <TextBlock Grid.Column="0"
                               Opacity="0.7"
                               Text="{Binding Timestamp, StringFormat={}{0:HH:mm:ss}}" />
                    <TextBlock Grid.Column="1"
                               Margin="8,0,0,0"
                               TextWrapping="Wrap"
                               Text="{Binding Message}" />
                  </Grid>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </ScrollViewer>
        </Border>
      </Grid>
    </Border>

    <Border DockPanel.Dock="Bottom"
            behaviors:DoubleTapBehavior.Command="{Binding ExpandStatusLogCommand}"
            Background="{DynamicResource WindowPanelBackgroundBrush}"
            BorderBrush="{DynamicResource WindowDividerBrush}"
            BorderThickness="0">
      <DockPanel LastChildFill="True">
        <StackPanel DockPanel.Dock="Right"
                    Orientation="Horizontal"
                    Spacing="6"
                    HorizontalAlignment="Right">
          <TextBlock Opacity="0.8" Text="Active Server:" />
          <TextBlock FontWeight="SemiBold" Text="{Binding ActiveServerName}" />
        </StackPanel>
        <TextBlock Text="{Binding StatusText}" HorizontalAlignment="Stretch" />
      </DockPanel>
    </Border>

    <fa:NavigationView x:Name="ManagementNavigationView"
                       PaneDisplayMode="Left"
                       IsBackButtonVisible="False"
                       IsPaneToggleButtonVisible="True"
                       IsPaneOpen="True"
                       IsSettingsVisible="True"
                       behaviors:NavigationViewItemInvokedBehavior.Command="{Binding SetManagementSectionCommand}"
                       behaviors:NavigationViewItemInvokedBehavior.SettingsKey="Settings">
        <fa:NavigationView.MenuItems>
          <fa:NavigationViewItem Tag="ServerSetup">
            <StackPanel Orientation="Horizontal" Spacing="14">
              <fa:FontIcon Glyph="&#xE713;" />
              <TextBlock Text="Server Setup" />
            </StackPanel>
          </fa:NavigationViewItem>
          <fa:NavigationViewItem Tag="Sessions">
            <StackPanel Orientation="Horizontal" Spacing="14">
              <fa:FontIcon Glyph="&#xE8BD;" />
              <TextBlock Text="Sessions" />
            </StackPanel>
          </fa:NavigationViewItem>
          <fa:NavigationViewItem x:Name="NavLocalServerItem" Tag="LocalServer">
            <StackPanel Orientation="Horizontal" Spacing="14">
              <fa:FontIcon Glyph="&#xEC4F;" />
              <TextBlock Text="Local Server" />
            </StackPanel>
          </fa:NavigationViewItem>
          <fa:NavigationViewItem Tag="OpenSessions">
            <StackPanel Orientation="Horizontal" Spacing="14">
              <fa:FontIcon Glyph="&#xE8A5;" />
              <TextBlock Text="Open Sessions" />
            </StackPanel>
          </fa:NavigationViewItem>
          <fa:NavigationViewItem Tag="StructuredLogs">
            <StackPanel Orientation="Horizontal" Spacing="14">
              <fa:FontIcon Glyph="&#xE9D9;" />
              <TextBlock Text="Structured Logs" />
            </StackPanel>
          </fa:NavigationViewItem>
          <fa:NavigationViewItem Tag="Security">
            <StackPanel Orientation="Horizontal" Spacing="14">
              <fa:FontIcon Glyph="&#xE72E;" />
              <TextBlock Text="Security" />
            </StackPanel>
          </fa:NavigationViewItem>
          <fa:NavigationViewItem Tag="History">
            <StackPanel Orientation="Horizontal" Spacing="14">
              <fa:FontIcon Glyph="&#xE81C;" />
              <TextBlock Text="History" />
            </StackPanel>
          </fa:NavigationViewItem>
          <fa:NavigationViewItem Tag="AuthUsers">
            <StackPanel Orientation="Horizontal" Spacing="14">
              <fa:FontIcon Glyph="&#xE77B;" />
              <TextBlock Text="Auth Users" />
            </StackPanel>
          </fa:NavigationViewItem>
          <fa:NavigationViewItem Tag="Plugins">
            <StackPanel Orientation="Horizontal" Spacing="14">
              <fa:FontIcon Glyph="&#xE7FC;" />
              <TextBlock Text="Plugins" />
            </StackPanel>
          </fa:NavigationViewItem>
          <fa:NavigationViewItem Tag="Mcp">
            <StackPanel Orientation="Horizontal" Spacing="14">
              <fa:FontIcon Glyph="&#xE943;" />
              <TextBlock Text="MCP" />
            </StackPanel>
          </fa:NavigationViewItem>
          <fa:NavigationViewItem Tag="Prompts">
            <StackPanel Orientation="Horizontal" Spacing="14">
              <fa:FontIcon Glyph="&#xE8C8;" />
              <TextBlock Text="Prompts" />
            </StackPanel>
          </fa:NavigationViewItem>
          <fa:NavigationViewItem Tag="AppLog">
            <StackPanel Orientation="Horizontal" Spacing="14">
              <fa:FontIcon Glyph="&#xE9D9;" />
              <TextBlock Text="App Log" />
            </StackPanel>
          </fa:NavigationViewItem>
        </fa:NavigationView.MenuItems>
        <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
          <Grid>
            <panels:ServerSetupPanel    IsVisible="{Binding IsServerSetupSectionSelected}" />
            <panels:SessionsPanel       IsVisible="{Binding IsSessionsSectionSelected}" />
            <panels:LocalServerPanel    IsVisible="{Binding IsLocalServerSectionSelected}" />
            <panels:OpenSessionsPanel   IsVisible="{Binding IsOpenSessionsSectionSelected}" />
            <panels:StructuredLogsPanel IsVisible="{Binding IsStructuredLogsSectionSelected}" />
            <panels:SecurityPanel       IsVisible="{Binding IsSecuritySectionSelected}" />
            <panels:HistoryPanel        IsVisible="{Binding IsHistorySectionSelected}" />
            <panels:AuthUsersPanel      IsVisible="{Binding IsAuthUsersSectionSelected}" />
            <panels:PluginsPanel        IsVisible="{Binding IsPluginsSectionSelected}" />
            <panels:McpPanel            IsVisible="{Binding IsMcpSectionSelected}" />
            <panels:PromptsPanel        IsVisible="{Binding IsPromptsSectionSelected}" />
            <panels:AppLogPanel         IsVisible="{Binding IsAppLogSectionSelected}" />
            <panels:SettingsPanel       IsVisible="{Binding IsSettingsSectionSelected}" />
          </Grid>
        </ScrollViewer>
    </fa:NavigationView>
  </DockPanel>
</Window>
